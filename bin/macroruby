#!/usr/bin/env ruby

prelude=['require "macro"']

i=0
while i<ARGV.size

  #end of interpreter options? 
  break if /\A(?:[^-]|-?-\z)/===ARGV[i]

  all,er,rest=ARGV[i].match /\A[Sacdhlnpsvwy]*([er])(.*)\z/

  case er
  when 'r'  #input could come from file named w/ -r on cmd line
    if !rest.empty?
      prelude<<"Macro.require "+rest.inspect
    else
      ARGV[i]=nil
      prelude<<"Macro.require "+ARGV[i+=1].inspect
    end
    ARGV[i]=nil

  when 'e'  #input could come from -e string on the cmd line
    if !rest.empty?
      prelude<<rest
    else
      ARGV[i]=nil
      prelude<<ARGV[i+=1]
    end
    ARGV[i]=nil
    got_e=true
  end

  i+=1
end

#input could come from stdin
if "-"==ARGV[i] or !ARGV[i]
  ARGV[i]="-"
else
  prelude<<"Macro.load "+ARGV[i].inspect
  ARGV[i]=nil
end unless got_e

ARGV.compact!

ARGV.push "-e", prelude.join(';')

p ARGV
ruby=RbConfig::CONFIG['bindir']+'/'+RbConfig::CONFIG["ruby_install_name"]
#exec ruby,*ARGV #does not return
